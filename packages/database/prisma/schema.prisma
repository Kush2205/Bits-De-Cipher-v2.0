// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}
//@ts-expect-error
datasource db {
  provider = "postgresql"
}

/**
 * User Model
 * 
 * Stores user account information for both conventional and OAuth users.
 * - password is nullable to support OAuth-only users
 * - role field for admin/user permissions
 */
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String?  // Nullable for OAuth users
  role      String   @default("user") // "user" | "admin"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  accounts       Account[]         // OAuth accounts linked to this user
  participants   QuizParticipant[] // Quiz sessions this user participated in

  @@index([email])
}

/**
 * Account Model
 * 
 * Stores OAuth provider information for users who sign in via Google, GitHub, etc.
 * Allows users to link multiple OAuth providers to one account.
 * 
 * Example:
 * - provider: "google"
 * - providerId: "123456789" (Google user ID)
 * - accessToken: OAuth access token (optional, for API calls)
 */
model Account {
  id           String   @id @default(cuid())
  userId       String
  provider     String   // "google" | "github" | "facebook", etc.
  providerId   String   // Unique ID from OAuth provider
  accessToken  String?  // OAuth access token (encrypted recommended)
  refreshToken String?  // OAuth refresh token
  expiresAt    DateTime? // Token expiration
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Ensure one provider account per user
  @@unique([provider, providerId])
  @@index([userId])
}

/**
 * Quiz Model
 * 
 * Stores quiz metadata and configuration.
 * Admin users create quizzes with questions.
 */
model Quiz {
  id          String    @id @default(cuid())
  title       String
  description String?
  duration    Int       // Duration in seconds
  isPublished Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  questions Question[]
  sessions  QuizSession[]

  @@index([isPublished, createdAt])
}

/**
 * Question Model
 * 
 * Individual questions within a quiz.
 * Multiple choice format with options.
 */
model Question {
  id            String   @id @default(cuid())
  quizId        String
  text          String   // Question text
  order         Int      // Display order in quiz
  correctAnswer Int      // Index of correct option (0-based)
  points        Int      @default(10) // Points for correct answer
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  quiz    Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options Option[]
  answers Answer[]

  @@index([quizId, order])
}

/**
 * Option Model
 * 
 * Multiple choice options for each question.
 * Typically 2-6 options per question.
 */
model Option {
  id         String   @id @default(cuid())
  questionId String
  text       String   // Option text
  order      Int      // Display order
  createdAt  DateTime @default(now())

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId, order])
}

/**
 * QuizSession Model
 * 
 * Represents a quiz session - either a single user taking a quiz
 * or a multiplayer quiz room with multiple participants.
 * 
 * Status:
 * - "in_progress": Quiz is active
 * - "completed": Quiz finished
 * - "abandoned": User left before completing
 */
model QuizSession {
  id          String    @id @default(cuid())
  quizId      String
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  status      String    @default("in_progress") // "in_progress" | "completed" | "abandoned"

  // Relations
  quiz         Quiz              @relation(fields: [quizId], references: [id], onDelete: Cascade)
  participants QuizParticipant[]

  @@index([quizId, status, startedAt])
}

/**
 * QuizParticipant Model
 * 
 * Tracks individual user participation in a quiz session.
 * Stores score and progress for real-time leaderboards.
 */
model QuizParticipant {
  id                String   @id @default(cuid())
  sessionId         String
  userId            String
  totalScore        Int      @default(0)
  questionsAnswered Int      @default(0)
  joinedAt          DateTime @default(now())

  // Relations
  session QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers Answer[]

  // One participant per user per session
  @@unique([sessionId, userId])
  @@index([userId])
  @@index([sessionId, totalScore]) // For leaderboard queries
}

/**
 * Answer Model
 * 
 * Stores user's answer to each question.
 * Used for scoring and detailed results.
 */
model Answer {
  id             String   @id @default(cuid())
  participantId  String
  questionId     String
  selectedOption Int      // Index of selected option
  isCorrect      Boolean
  points         Int      // Points earned (0 if incorrect)
  timeTaken      Int      // Time taken in seconds
  answeredAt     DateTime @default(now())

  // Relations
  participant QuizParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  question    Question        @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // One answer per question per participant
  @@unique([participantId, questionId])
  @@index([participantId])
  @@index([questionId])
}
